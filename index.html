<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher's Smart Headcount App</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
            --success: #10b981;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: #1e293b; margin: 0; padding: 20px; }
        * { box-sizing: border-box; }

        .container { max-width: 1200px; margin: 0 auto; background: var(--white); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }

        /* Header & Strategy */
        header { background: var(--primary); color: white; padding: 25px; text-align: center; }
        h1 { margin: 0 0 10px 0; font-size: 1.8rem; }
        
        .strategy-bar {
            background: #eff6ff;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .strategy-bar label { font-weight: 700; color: var(--primary-dark); text-transform: uppercase; font-size: 0.85rem; }
        
        .inc-btn {
            background: white; border: 1px solid #bfdbfe; color: var(--primary); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .inc-btn.active, .inc-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        .custom-inc { width: 70px; padding: 8px; border: 1px solid #bfdbfe; border-radius: 6px; text-align: center; font-weight: bold; color: var(--primary); }

        /* Input Area (Tabs) */
        .input-section { padding: 30px; border-bottom: 1px solid var(--border); }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid var(--border); }
        .tab-btn {
            padding: 10px 20px; background: none; border: none; font-size: 1rem; color: var(--secondary); cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px;
        }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 700; }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* Paste Area */
        textarea {
            width: 100%; height: 150px; padding: 15px; border: 1px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 0.9rem; resize: vertical;
        }
        .paste-guide { font-size: 0.85rem; color: var(--secondary); margin-bottom: 5px; }

        /* File Upload Area */
        .drop-zone {
            border: 2px dashed #cbd5e1; border-radius: 8px; padding: 40px; text-align: center; background: #f1f5f9; cursor: pointer; transition: 0.2s;
        }
        .drop-zone:hover { border-color: var(--primary); background: #eff6ff; }

        /* Action Buttons */
        .action-row { margin-top: 20px; display: flex; gap: 10px; }
        .btn-main { background: var(--success); color: white; border: none; padding: 12px 25px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-main:hover { background: #059669; }
        .btn-clear { background: white; border: 1px solid #ef4444; color: #ef4444; padding: 12px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* Table */
        .table-wrapper { overflow-x: auto; max-height: 600px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 0.85rem; color: var(--secondary); border-bottom: 2px solid var(--border); position: sticky; top: 0; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        
        .col-tov { background: #eff6ff; font-weight: 600; color: var(--primary-dark); }
        .col-etr { background: #f0fdf4; font-weight: 700; color: #15803d; }
        .badge-gain { font-size: 0.75rem; background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Smart Headcount Calculator</h1>
        <p>Estimate ETR and OTIs instantly using a strategic increment.</p>
    </header>

    <div class="strategy-bar">
        <label>Strategic Increment:</label>
        <button class="inc-btn" onclick="setStrategy(5, this)">+5 (Safe)</button>
        <button class="inc-btn active" onclick="setStrategy(10, this)">+10 (Standard)</button>
        <button class="inc-btn" onclick="setStrategy(15, this)">+15 (High)</button>
        <div style="display:flex; align-items:center; gap:5px; margin-left:10px;">
            <span style="font-size:0.85rem;">Custom:</span>
            <input type="number" id="customInc" class="custom-inc" value="10" oninput="updateCustom(this.value)">
        </div>
    </div>

    <div class="input-section">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('paste')">ðŸ“‹ Copy & Paste</button>
            <button class="tab-btn" onclick="switchTab('upload')">ðŸ“‚ Upload Excel/CSV</button>
        </div>

        <div id="tab-paste" class="tab-content active">
            <p class="paste-guide"><strong>Tip:</strong> You can copy two columns (Name, TOV) directly from Excel and paste them here.</p>
            <textarea id="pasteArea" placeholder="Example format:&#10;Ali Bin Abu    45&#10;Siti Aminah    62&#10;Tan Ah Kow     78"></textarea>
            <div class="action-row">
                <button class="btn-main" onclick="processPastedData()">Calculate & Generate</button>
                <button class="btn-clear" onclick="clearData()">Clear All</button>
            </div>
        </div>

        <div id="tab-upload" class="tab-content">
            <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
                <p style="font-size: 1.2rem; font-weight: bold; color: var(--secondary);">Click to Select File</p>
                <p style="color: #94a3b8;">Supports CSV format (Name, TOV)</p>
                <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFile(this)">
            </div>
            <p style="text-align: center; font-size: 0.9rem; margin-top: 10px; color: var(--primary); cursor: pointer; text-decoration: underline;" onclick="downloadTemplate()">Download Template File</p>
        </div>
    </div>

    <div class="table-wrapper">
        <table id="resultTable">
            <thead>
                <tr>
                    <th style="width: 5%;">#</th>
                    <th style="width: 30%;">Student Name</th>
                    <th class="col-tov">TOV (Current)</th>
                    <th>OTI 1</th>
                    <th>OTI 2</th>
                    <th>OTI 3</th>
                    <th class="col-etr">ETR (Target)</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="7" style="text-align:center; padding: 40px; color: #94a3b8;">No data loaded yet.</td></tr>
            </tbody>
        </table>
    </div>
    
    <div style="padding: 20px; text-align: right; background: #f8fafc; border-top: 1px solid var(--border);">
        <button class="btn-main" style="background-color: #475569;" onclick="exportToCSV()">Download Results</button>
    </div>
</div>

<script>
    let students = [];
    let increment = 10;

    // --- UI Logic ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.add('active');
        // Find button that called this (rough match)
        const btnIndex = tabId === 'paste' ? 0 : 1;
        document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
    }

    function setStrategy(val, btn) {
        increment = parseInt(val);
        document.getElementById('customInc').value = increment;
        document.querySelectorAll('.inc-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(students.length > 0) renderTable(); // Live update
    }

    function updateCustom(val) {
        increment = parseInt(val) || 0;
        document.querySelectorAll('.inc-btn').forEach(b => b.classList.remove('active'));
        if(students.length > 0) renderTable();
    }

    // --- Data Processing ---
    function processPastedData() {
        const raw = document.getElementById('pasteArea').value;
        if(!raw.trim()) { alert("Please paste some data first."); return; }
        
        const lines = raw.split('\n');
        parseLines(lines);
    }

    function handleFile(input) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n');
            parseLines(lines);
            input.value = ''; // reset
            switchTab('paste'); // Switch view to show data
        };
        reader.readAsText(file);
    }

    function parseLines(lines) {
        let tempStudents = [];
        
        lines.forEach(line => {
            line = line.trim();
            if(!line) return;

            // Detect delimiter: Tab (Excel paste) or Comma (CSV)
            let parts;
            if (line.includes('\t')) {
                parts = line.split('\t');
            } else if (line.includes(',')) {
                parts = line.split(',');
            } else {
                // Fallback: split by multiple spaces
                parts = line.split(/\s{2,}/); 
            }

            // Clean up parts
            parts = parts.map(p => p.trim()).filter(p => p !== '');

            // We need at least Name and TOV
            if (parts.length >= 2) {
                // Assume Last column is Marks, First is Name
                // If 2 columns: Name, Mark
                // If 3 columns (No, Name, Mark): We take 2 and 3
                
                let name = parts[0];
                let tovStr = parts[parts.length - 1]; // Take the last item as mark

                // If user pasted "1. Name Mark", remove the leading number
                if(parts.length > 2 && !isNaN(parts[0])) {
                     name = parts[1];
                }

                let tov = parseFloat(tovStr);

                if (!isNaN(tov)) {
                    tempStudents.push({ name: name, tov: tov });
                }
            }
        });

        if (tempStudents.length > 0) {
            students = tempStudents;
            renderTable();
            alert(`Successfully loaded ${students.length} students!`);
        } else {
            alert("Could not recognize data. Please ensure format is 'Name [tab] Mark'");
        }
    }

    // --- Calculation & Rendering ---
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        students.forEach((s, index) => {
            // Calculation
            let etr = s.tov + increment;
            if(etr > 100) etr = 100; // Cap at 100

            const totalGrowth = etr - s.tov;
            const step = totalGrowth / 4;

            const oti1 = s.tov + step;
            const oti2 = s.tov + (step * 2);
            const oti3 = s.tov + (step * 3);

            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td>${s.name}</td>
                    <td class="col-tov">${s.tov}</td>
                    <td>${fmt(oti1)}</td>
                    <td>${fmt(oti2)}</td>
                    <td>${fmt(oti3)}</td>
                    <td class="col-etr">
                        ${fmt(etr)}
                        <span class="badge-gain">+${fmt(totalGrowth)}</span>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function fmt(num) {
        return Number.isInteger(num) ? num : num.toFixed(2);
    }

    function clearData() {
        students = [];
        document.getElementById('pasteArea').value = '';
        renderTable();
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 40px; color: #94a3b8;">No data loaded yet.</td></tr>';
    }

    // --- Exports ---
    function downloadTemplate() {
        const csv = "data:text/csv;charset=utf-8,Student Name,TOV Mark\nAli Bin Abu,45\nSiti Aminah,60";
        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = "headcount_template.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportToCSV() {
        if(students.length === 0) { alert("No data to export"); return; }
        
        let csv = "data:text/csv;charset=utf-8,Name,TOV,OTI 1,OTI 2,OTI 3,ETR\n";
        students.forEach(s => {
            let etr = Math.min(s.tov + increment, 100);
            let step = (etr - s.tov) / 4;
            csv += `${s.name},${s.tov},${fmt(s.tov+step)},${fmt(s.tov+step*2)},${fmt(s.tov+step*3)},${fmt(etr)}\n`;
        });

        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = "headcount_complete.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
