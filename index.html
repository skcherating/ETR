<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headcount Pro v10: Ultimate Smart Match</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #4f46e5; 
            --bg: #f3f4f6; 
            --white: #ffffff; 
            --text: #1f2937; 
            --border: #d1d5db; 
            --success: #059669; 
            --warning: #f59e0b;
        }
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; background: var(--white); padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e5e7eb; padding-bottom: 20px; }
        h1 { color: var(--primary); margin: 0; font-size: 1.8rem; letter-spacing: -0.5px; }
        .brand-subtitle { font-size: 1rem; color: #6b7280; font-weight: 400; margin-left: 5px; }
        .header-actions { display: flex; gap: 10px; }

        /* STRATEGY PANEL */
        .strategy-panel { background: #eef2ff; border: 1px solid #c7d2fe; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
        .strat-header { margin-bottom: 12px; font-size: 0.85rem; text-transform: uppercase; color: #6366f1; font-weight: 800; letter-spacing: 0.5px; }
        .strat-row { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
        .strat-row:last-child { margin-bottom: 0; }
        label { font-weight: 600; cursor: pointer; color: #312e81; }
        input[type="radio"] { transform: scale(1.2); cursor: pointer; margin-right: 8px; accent-color: var(--primary); }
        input[type="number"] { width: 70px; padding: 8px; border: 2px solid #c7d2fe; border-radius: 6px; text-align: center; font-weight: bold; font-size: 1rem; color: var(--primary); }
        input[type="number"]:disabled { background: #e5e7eb; border-color: #d1d5db; color: #9ca3af; }
        .btn-shuffle { background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 10px; display: none; }

        /* DATA ENTRY SECTION */
        .data-entry-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .step-box { border: 1px solid var(--border); border-radius: 10px; padding: 20px; background: #f9fafb; display: flex; flex-direction: column; }
        .step-title { font-weight: 700; margin-bottom: 10px; display: block; font-size: 1rem; color: var(--primary); }
        .step-desc { font-size: 0.85rem; color: #666; margin-bottom: 15px; }
        textarea { width: 100%; height: 150px; padding: 10px; border-radius: 8px; border: 1px solid #9ca3af; font-family: monospace; resize: vertical; font-size: 0.85rem; flex-grow: 1; }

        /* UPLOAD BOX STYLES */
        .upload-area {
            border: 2px dashed #a5b4fc; background: #eef2ff; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; height: 100%;
        }
        .upload-area:hover { background: #e0e7ff; border-color: var(--primary); }
        .upload-icon { font-size: 2rem; margin-bottom: 10px; }
        #fileInput { display: none; }
        .file-name { margin-top: 10px; font-weight: bold; color: var(--success); font-size: 0.9rem; }

        /* TABS for Step 2 */
        .tab-container { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn { background: #e5e7eb; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: block; }


        /* COLUMN PICKER */
        #columnPicker { display: none; background: #ecfdf5; border-color: #6ee7b7; padding: 20px; border-radius: 10px; border: 1px solid #6ee7b7; margin-bottom: 25px; }
        .picker-grid { display: flex; gap: 20px; align-items: flex-end; margin-top: 10px; flex-wrap: wrap; }
        .picker-group { display: flex; flex-direction: column; gap: 5px; }
        select { padding: 10px; border-radius: 6px; border: 1px solid #9ca3af; min-width: 200px; font-size: 0.95rem; }

        /* TEACHER/ADMIN SELECTOR */
        .signature-controls {
            background: #fff; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px; margin-bottom: 20px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px;
        }
        .sig-section h4 { margin: 0 0 10px 0; color: var(--primary); font-size: 0.9rem; text-transform: uppercase; }
        .input-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .input-group label { font-size: 0.85rem; color: #6b7280; font-weight: 600; }
        .input-group input, .input-group select { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; font-size: 0.9rem; }

        /* BUTTONS */
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; font-size: 1rem; }
        .btn-blue { background: var(--primary); width: 100%; margin-top: 10px; }
        .btn-green { background: var(--success); }
        .btn-dark { background: #374151; padding: 10px 20px; font-size: 0.9rem; }
        .btn-excel { background: #059669; padding: 10px 20px; font-size: 0.9rem; }

        /* TABLE */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; font-size: 0.95rem; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        th { text-align: left; padding: 15px; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; font-weight: 700; color: #4b5563; }
        td { padding: 12px 15px; border-bottom: 1px solid #f3f4f6; }
        .col-target { background: #f0fdf4; color: #166534; font-weight: 700; border-left: 1px solid #e5e7eb; }
        .col-gain { color: #059669; font-weight: 700; background: #ecfdf5; text-align: center; }

        /* PRINT OPTIMIZATION (A4 & 10pt) */
        @media print {
            @page { size: A4; margin: 1.5cm; }
            body { background: white; font-family: Arial, sans-serif; font-size: 10pt; color: black; padding: 0; margin: 0; }
            .container { box-shadow: none; margin: 0; padding: 0; max-width: 100%; width: 100%; }
            .data-entry-grid, .strategy-panel, .btn, .btn-shuffle, .header-actions, #columnPicker, .signature-controls { display: none !important; }
            .col-gain { display: none !important; }
            header { border-bottom: 2px solid black; margin-bottom: 15px; padding-bottom: 10px; justify-content: center; }
            h1 { color: black; font-size: 16pt; text-transform: uppercase; }
            #resultSection { display: block !important; }
            h3 { font-size: 12pt; margin-bottom: 10px; border: none !important; padding: 0 !important; }
            table { width: 100%; border-collapse: collapse; border: 1px solid black; font-size: 10pt; }
            th, td { border: 1px solid black; color: black !important; padding: 4px 6px; font-size: 10pt; }
            th { background-color: #f0f0f0 !important; font-weight: bold; }
            .col-target { background: none !important; color: black !important; border-left: 1px solid black; }
            tr { page-break-inside: avoid; }
            .print-footer { display: flex !important; margin-top: 50px; justify-content: space-between; page-break-inside: avoid; width: 100%; }
            .sig-block { width: 45%; }
            .sig-title { font-weight: bold; margin-bottom: 40px; }
            .sig-line { border-top: 1px solid black; margin-top: 5px; margin-bottom: 5px; }
            .sig-text { font-size: 10pt; line-height: 1.5; text-transform: uppercase; }
        }
        .print-footer { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Headcount Pro <span class="brand-subtitle">v10 Ultimate</span></h1>
        <div class="header-actions">
            <button class="btn btn-excel" onclick="downloadExcel()">üì• Excel</button>
            <button class="btn btn-dark" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>
    </header>

    <div class="strategy-panel">
        <div class="strat-header">Strategi TOV ke ETR</div>
        <div class="strat-row">
            <input type="radio" name="strategy" id="stratFixed" value="fixed" checked onchange="updateLive()">
            <label for="stratFixed">Kenaikan Tetap:</label>
            <input type="number" id="fixedVal" value="10" oninput="updateLive()"> 
            <span>markah.</span>
        </div>
        <div class="strat-row">
            <input type="radio" name="strategy" id="stratRandom" value="random" onchange="updateLive()">
            <label for="stratRandom">Kenaikan Rawak (Julat):</label>
            <span>Antara</span>
            <input type="number" id="randMin" value="5" disabled oninput="updateLive()"> 
            <span>hingga</span>
            <input type="number" id="randMax" value="12" disabled oninput="updateLive()"> 
            <span>markah.</span>
            <button class="btn-shuffle" id="btnShuffle" onclick="forceReShuffle()">üé≤ Shuffle</button>
        </div>
    </div>

    <div class="data-entry-grid">
        <div class="step-box" style="border-color: #4f46e5; background: #eef2ff;">
            <span class="step-title">1. Senarai Nama Master (Terkini)</span>
            <span class="step-desc">Paste senarai nama murid ikut susunan kelas 2026 di sini.</span>
            <textarea id="masterListArea" placeholder="Contoh:&#10;1. ABU BIN ALl&#10;2. SITI AMINAH&#10;..."></textarea>
        </div>

        <div class="step-box">
            <span class="step-title">2. Sumber Data Markah</span>
            
            <div class="tab-container">
                <button class="tab-btn active" onclick="switchTab('upload')">üìÇ Upload Excel</button>
                <button class="tab-btn" onclick="switchTab('paste')">üìã Paste Manual</button>
            </div>

            <div id="tab-upload" class="tab-content active">
                <span class="step-desc">Upload fail Excel (.xlsx) atau CSV yang mengandungi markah semua kelas.</span>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÇ</div>
                    <div>Klik untuk pilih fail Excel</div>
                    <div id="fileNameDisplay" class="file-name"></div>
                    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" onchange="handleFile(this)">
                </div>
            </div>

            <div id="tab-paste" class="tab-content">
                <span class="step-desc">Atau paste data dari pelbagai kelas di sini (campur pun tak apa).</span>
                <textarea id="rawMarkArea" placeholder="Paste data markah di sini..."></textarea>
            </div>
        </div>
    </div>
    
    <button class="btn btn-blue" onclick="processData()" style="margin-bottom: 20px;">üîç Match & Analyze Data</button>

    <div id="columnPicker">
        <span class="step-title">3. Pilih Kolum Data</span>
        <p style="margin:0 0 15px 0; color: #6b7280;">Sila tentukan kolum mana mewakili Nama dan Markah Subjek.</p>
        <div class="picker-grid">
            <div class="picker-group">
                <label>Kolum Nama:</label>
                <select id="nameCol"></select>
            </div>
            <div class="picker-group">
                <label>Kolum Markah (TOV):</label>
                <select id="markCol"></select>
            </div>
            <button class="btn btn-green" onclick="generateHeadcount()">Jana Headcount</button>
        </div>
    </div>

    <div id="resultSection" style="display:none;">
        
        <div class="signature-controls">
            <div class="sig-section">
                <h4>Disediakan Oleh</h4>
                <div class="input-group">
                    <label>Nama Guru:</label>
                    <input list="teacherList" id="teacherInput" placeholder="Pilih nama..." onchange="updateSignature()">
                    <datalist id="teacherList"></datalist>
                </div>
                <div class="input-group">
                    <label>Jawatan:</label>
                    <select id="jawatanInput" onchange="updateSignature()">
                        <option value="" disabled selected>Pilih Jawatan...</option>
                        <optgroup label="GURU MATA PELAJARAN (TERAS)">
                            <option value="GURU MATA PELAJARAN BAHASA MELAYU">GURU MATA PELAJARAN BAHASA MELAYU</option>
                            <option value="GURU MATA PELAJARAN BAHASA INGGERIS">GURU MATA PELAJARAN BAHASA INGGERIS</option>
                            <option value="GURU MATA PELAJARAN MATEMATIK">GURU MATA PELAJARAN MATEMATIK</option>
                            <option value="GURU MATA PELAJARAN SAINS">GURU MATA PELAJARAN SAINS</option>
                            <option value="GURU MATA PELAJARAN PENDIDIKAN ISLAM">GURU MATA PELAJARAN PENDIDIKAN ISLAM</option>
                            <option value="GURU MATA PELAJARAN SEJARAH">GURU MATA PELAJARAN SEJARAH</option>
                        </optgroup>
                        <optgroup label="KETUA PANITIA">
                            <option value="KETUA PANITIA BAHASA MELAYU">KETUA PANITIA BAHASA MELAYU</option>
                            <option value="KETUA PANITIA MATEMATIK">KETUA PANITIA MATEMATIK</option>
                            <option value="KETUA PANITIA SAINS">KETUA PANITIA SAINS</option>
                            <option value="KETUA PANITIA BAHASA INGGERIS">KETUA PANITIA BAHASA INGGERIS</option>
                        </optgroup>
                    </select>
                </div>
            </div>
            <div class="sig-section">
                <h4>Disahkan Oleh</h4>
                <div class="input-group">
                    <label>Nama Pentadbir:</label>
                    <input list="adminList" id="adminInput" placeholder="Pilih..." onchange="autoFillAdmin()">
                    <datalist id="adminList"></datalist>
                </div>
                <div class="input-group">
                    <label>Jawatan:</label>
                    <input type="text" id="adminJawatanInput" value="GURU BESAR" oninput="updateSignature()">
                </div>
            </div>
        </div>

        <h3 id="subjectTitle" style="margin-bottom:15px; color:#374151; border-left: 5px solid var(--primary); padding-left: 10px;"></h3>
        <table id="dataTable">
            <thead>
                <tr>
                    <th style="width: 5%;">No</th>
                    <th>Nama Murid</th>
                    <th>TOV</th>
                    <th>OTI1</th>
                    <th>OTI2</th>
                    <th>OTI3</th>
                    <th class="col-target">ETR</th>
                    <th class="col-gain" style="width: 10%;">Gain</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        
        <div class="print-footer">
            <div class="sig-block">
                <div class="sig-title">Disediakan oleh,</div>
                <br><br><br>
                <div class="sig-line"></div>
                <div class="sig-text">Nama: <span id="printName">..............................................................</span></div>
                <div class="sig-text">Jawatan: <span id="printJawatan">...........................................................</span></div>
            </div>
            <div class="sig-block">
                <div class="sig-title">Disahkan oleh,</div>
                <br><br><br>
                <div class="sig-line"></div>
                <div class="sig-text">Nama: <span id="printAdminName">..............................................................</span></div>
                <div class="sig-text">Jawatan: <span id="printAdminJawatan">...........................................................</span></div>
            </div>
        </div>
    </div>
</div>

<script>
    // === DATA CONFIGURATION ===
    const teachers = [
        "AMIRAH BINTI CHE AZUHA", "AZLAN BIN DAUD", "AZLINA BINTI HANAPI", "AMANI BINTI AWANG QAMARULDEEN",
        "ANWAR SHAFIQ BIN JAMALUDIN", "ANIS SYAZWANI BINTI MAT ISA", "BAHJATU SHOLIHAH BINTI RAMAN",
        "FAZILAH BINTI MUDA", "HANIS AYUNI BINTI HADI", "MAKTAR BIN MOHAMED", "MOHD AFIZU BIN ADENAN",
        "MUHAMAD HAKIMI BIN AMER", "MUHAMMAD SAUFI FIRDAUS BIN SABUDIN", "NURAZIZAH BINTI OMAR",
        "NOOR IDAYU BINTI ISMAIL", "NOOR AIN BINTI MOHD YUSOFF", "NOR HUDA DHAMIRAH BINTI ISA",
        "NUR IDAYU BINTI ABDULL ROZAK", "NOR NAZAHIYAH BINTI NASARUDIN", "NOR SHAZIRA BINTI AZIZ",
        "NOR SYAZALIAH BINTI MAT RADZI", "NURIN IZZAH BINTI ROSMAN", "NUR FATIHATULHUSNA BINTI YA'ACOB",
        "NURUL ADILLAH BINTI ZAKARIA", "NURUL IZZATI BINTI MUHAMMAD NAZIR", "NUR ZAKIAH BINTI ZAINUDDIN",
        "RAJIAH BINTI HAJI MUHAMMAD", "RAMLAH BINTI HASSAN", "RAZIAH BINTI WAHAB", "RAUDZAH BINTI HAJI KAMALUDIN",
        "RASHIDAH BINTI ZULKIFLI", "ROSHANIDA BINTI ROHANUDDIN", "SITI ZURAIHA BINTI MAPOL",
        "SUHAIDA BINTI SIDEK", "SUHAIMI BIN ISMAIL", "SUZIMARLIANA BINTI IBRAHIM", "SYAIMA' BINTI ABDUL HALIM@BAKAR",
        "UMMI FARAH BINTI ALIAS", "WAN SITI NOR ADILAH BINTI WAN OTHMAN", "WAN NOOR UMMI BINTI W.RAMLI",
        "ZURAYA BINTI OTHMAN", "ZIRATUL ASYIKIN BINTI MUSA", "ZAILATUL ROZAIDI BIN ZAKARIA"
    ];
    const admins = [
        { name: "ASRI BIN MOHAMED", pos: "GURU BESAR" },
        { name: "TUAN KAMARIAH BINTI TUAN SARIF", pos: "PENOLONG KANAN PENTADBIRAN" },
        { name: "ZAINON BINTI HJ JUFRI", pos: "PENOLONG KANAN HAL EHWAL MURID" },
        { name: "ASYRAF BIN ROSLAN", pos: "PENOLONG KANAN KO-KURIKULUM" }
    ];

    // Populate Lists
    const teacherDatalist = document.getElementById('teacherList');
    teachers.forEach(n => { let o = document.createElement('option'); o.value = n; teacherDatalist.appendChild(o); });
    const adminDatalist = document.getElementById('adminList');
    admins.forEach(a => { let o = document.createElement('option'); o.value = a.name; adminDatalist.appendChild(o); });

    function autoFillAdmin() {
        const selected = document.getElementById('adminInput').value;
        const obj = admins.find(a => a.name === selected);
        if (obj) document.getElementById('adminJawatanInput').value = obj.pos;
        updateSignature();
    }
    function updateSignature() {
        document.getElementById('printName').textContent = document.getElementById('teacherInput').value || "..............................................................";
        document.getElementById('printJawatan').textContent = document.getElementById('jawatanInput').value || "...........................................................";
        document.getElementById('printAdminName').textContent = document.getElementById('adminInput').value || "..............................................................";
        document.getElementById('printAdminJawatan').textContent = document.getElementById('adminJawatanInput').value || "...........................................................";
    }

    // === UI SWITCHING ===
    let activeSource = 'upload'; // 'upload' or 'paste'

    function switchTab(mode) {
        activeSource = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        if (mode === 'upload') {
            document.querySelector("button[onclick=\"switchTab('upload')\"]").classList.add('active');
            document.getElementById('tab-upload').classList.add('active');
        } else {
            document.querySelector("button[onclick=\"switchTab('paste')\"]").classList.add('active');
            document.getElementById('tab-paste').classList.add('active');
        }
    }

    // === FILE HANDLING ===
    let uploadedData = null;

    function handleFile(input) {
        const file = input.files[0];
        if(!file) return;

        document.getElementById('fileNameDisplay').textContent = "Fail: " + file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            // Assume first sheet
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            
            // Convert to JSON (Array of Arrays)
            uploadedData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
        };
        reader.readAsArrayBuffer(file);
    }


    // === SMART MATCH LOGIC ===
    let masterList = [];
    let rawDataMap = {}; 
    let rawHeaders = [];
    let rawRows = []; 
    let isDataLoaded = false;
    let processedData = [];

    function updateLive() {
        const isFixed = document.getElementById('stratFixed').checked;
        document.getElementById('fixedVal').disabled = !isFixed;
        document.getElementById('randMin').disabled = isFixed;
        document.getElementById('randMax').disabled = isFixed;
        document.getElementById('btnShuffle').style.display = isFixed ? 'none' : 'inline-block';
        if(isDataLoaded) generateHeadcount();
    }

    function forceReShuffle() { if(isDataLoaded) generateHeadcount(); }

    // Step 1: Process Inputs
    function processData() {
        const masterText = document.getElementById('masterListArea').value.trim();
        
        if(!masterText) return alert("Sila isi Master List dahulu.");
        
        // 1. Process Master List
        masterList = masterText.split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0)
            .map(line => line.replace(/^\d+[\.\)]\s*/, '')); 

        // 2. Get Raw Data (From File or Paste)
        if (activeSource === 'upload') {
            if (!uploadedData) return alert("Sila upload fail Excel dahulu.");
            rawRows = uploadedData; // Already array of arrays
            // Check if valid
            if (rawRows.length < 2) return alert("Fail Excel kosong atau tidak sah.");
            rawHeaders = rawRows[0];
            rawRows = rawRows.slice(1); // Remove header
        } else {
            // Paste Mode
            const rawText = document.getElementById('rawMarkArea').value.trim();
            if(!rawText) return alert("Sila paste data markah.");
            
            const lines = rawText.split('\n');
            let firstLine = lines[0].trim();
            let delim = firstLine.includes('\t') ? '\t' : (firstLine.includes(',') ? ',' : ' ');
            
            rawHeaders = firstLine.split(delim).map(h => h.trim());
            
            rawRows = lines.slice(1).map(line => {
                let parts = (delim === ' ') ? line.trim().split(/\s+/) : line.split(delim);
                return parts;
            });
        }

        if(rawHeaders.length < 2) return alert("Data Markah mesti ada sekurang-kurangnya 2 lajur.");

        // Setup Pickers
        const nameSel = document.getElementById('nameCol');
        const markSel = document.getElementById('markCol');
        nameSel.innerHTML = ''; markSel.innerHTML = '';
        
        rawHeaders.forEach((h, i) => {
            let safeH = h || `Column ${i+1}`;
            let o = `<option value="${i}">${safeH}</option>`;
            nameSel.innerHTML += o;
            markSel.innerHTML += o;
        });

        // Smart Guess
        rawHeaders.forEach((h, i) => {
            if (!h) return;
            let low = h.toString().toLowerCase();
            if(low.includes('name') || low.includes('nama')) nameSel.value = i;
            if(low.includes('mark') || low.includes('tov') || low.includes('gred')) markSel.value = i;
        });

        document.getElementById('columnPicker').style.display = 'block';
    }

    // Step 2: Generate Map & Table
    function generateHeadcount() {
        const nameIdx = parseInt(document.getElementById('nameCol').value);
        const markIdx = parseInt(document.getElementById('markCol').value);
        const subject = document.getElementById('markCol').options[markIdx].text;
        
        // 1. Build Map from Raw Data
        rawDataMap = {};
        rawRows.forEach(row => {
            if(row.length > Math.max(nameIdx, markIdx)) {
                let nVal = row[nameIdx];
                let mVal = row[markIdx];
                
                if (nVal !== undefined) {
                    let n = nVal.toString().trim().toUpperCase();
                    let m = parseFloat(mVal);
                    if(n && !isNaN(m)) {
                        rawDataMap[n] = m;
                    }
                }
            }
        });

        // 2. Build Table
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        processedData = [];
        
        const isFixed = document.getElementById('stratFixed').checked;
        const fixedVal = parseInt(document.getElementById('fixedVal').value) || 10;
        let minVal = parseInt(document.getElementById('randMin').value) || 5;
        let maxVal = parseInt(document.getElementById('randMax').value) || 12;
        if (minVal > maxVal) { let temp = minVal; minVal = maxVal; maxVal = temp; }

        let count = 0;
        masterList.forEach(masterName => {
            count++;
            let key = masterName.toUpperCase();
            let tov = rawDataMap[key] !== undefined ? rawDataMap[key] : 0; 
            
            let inc = isFixed ? fixedVal : Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
            let etr = tov + inc;
            if(etr > 100) etr = 100;
            
            let step = (etr - tov) / 4;
            let oti1 = fmt(tov + step);
            let oti2 = fmt(tov + step*2);
            let oti3 = fmt(tov + step*3);
            let etrFmt = fmt(etr);

            processedData.push({name: masterName, tov: tov, oti1, oti2, oti3, etr: etrFmt, gain: inc});

            let row = `<tr>
                <td>${count}</td>
                <td>${masterName}</td>
                <td>${tov}</td>
                <td>${oti1}</td>
                <td>${oti2}</td>
                <td>${oti3}</td>
                <td class="col-target">${etrFmt}</td>
                <td class="col-gain">+${inc}</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        document.getElementById('subjectTitle').innerText = "Analisis Headcount: " + subject;
        document.getElementById('resultSection').style.display = 'block';
        isDataLoaded = true;
        updateSignature();
    }

    function downloadExcel() {
        if (!processedData.length) return alert("Tiada data.");
        let csv = "data:text/csv;charset=utf-8,No,Nama Murid,TOV,OTI 1,OTI 2,OTI 3,ETR,Peningkatan\n";
        processedData.forEach((row, i) => {
            let n = row.name.includes(',') ? `"${row.name}"` : row.name;
            csv += `${i+1},${n},${row.tov},${row.oti1},${row.oti2},${row.oti3},${row.etr},${row.gain}\n`;
        });
        const markIdx = parseInt(document.getElementById('markCol').value);
        const subject = document.getElementById('markCol').options[markIdx] ? document.getElementById('markCol').options[markIdx].text : "Headcount";
        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = `Analisis_Headcount_${subject.replace(/[^a-z0-9]/gi, '_')}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    function fmt(n) { return Number.isInteger(n) ? n : n.toFixed(2); }
</script>

</body>
</html>
