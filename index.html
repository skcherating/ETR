<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headcount Like a Pro by Nexus</title>
    <style>
        :root { 
            --primary: #4f46e5; 
            --bg: #f3f4f6; 
            --white: #ffffff; 
            --text: #1f2937; 
            --border: #d1d5db; 
            --success: #059669; 
            --accent: #818cf8;
        }
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; background: var(--white); padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e5e7eb; padding-bottom: 20px; }
        h1 { color: var(--primary); margin: 0; font-size: 1.8rem; letter-spacing: -0.5px; }
        .brand-subtitle { font-size: 1rem; color: #6b7280; font-weight: 400; margin-left: 5px; }
        .header-actions { display: flex; gap: 10px; }

        /* STRATEGY PANEL */
        .strategy-panel { background: #eef2ff; border: 1px solid #c7d2fe; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
        .strat-header { margin-bottom: 12px; font-size: 0.85rem; text-transform: uppercase; color: #6366f1; font-weight: 800; letter-spacing: 0.5px; }
        .strat-row { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
        .strat-row:last-child { margin-bottom: 0; }
        label { font-weight: 600; cursor: pointer; color: #312e81; }
        input[type="radio"] { transform: scale(1.2); cursor: pointer; margin-right: 8px; accent-color: var(--primary); }
        input[type="number"] { width: 70px; padding: 8px; border: 2px solid #c7d2fe; border-radius: 6px; text-align: center; font-weight: bold; font-size: 1rem; color: var(--primary); }
        input[type="number"]:disabled { background: #e5e7eb; border-color: #d1d5db; color: #9ca3af; }
        .btn-shuffle { background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 10px; display: none; }

        /* INPUTS */
        .step-box { border: 1px solid var(--border); border-radius: 10px; padding: 25px; margin-bottom: 25px; background: #f9fafb; }
        .step-title { font-weight: 700; margin-bottom: 12px; display: block; font-size: 1.1rem; }
        textarea { width: 100%; height: 120px; padding: 15px; border-radius: 8px; border: 1px solid #9ca3af; font-family: monospace; resize: vertical; }
        
        /* COLUMN PICKER */
        #columnPicker { display: none; background: #ecfdf5; border-color: #6ee7b7; }
        .picker-grid { display: flex; gap: 20px; align-items: flex-end; margin-top: 10px; flex-wrap: wrap; }
        .picker-group { display: flex; flex-direction: column; gap: 5px; }
        select { padding: 10px; border-radius: 6px; border: 1px solid #9ca3af; min-width: 200px; font-size: 0.95rem; }

        /* TEACHER/ADMIN SELECTOR */
        .signature-controls {
            background: #fff; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px; margin-bottom: 20px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px;
        }
        .sig-section h4 { margin: 0 0 10px 0; color: var(--primary); font-size: 0.9rem; text-transform: uppercase; }
        .input-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .input-group label { font-size: 0.85rem; color: #6b7280; font-weight: 600; }
        .input-group input, .input-group select { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; font-size: 0.9rem; }

        /* BUTTONS */
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; font-size: 1rem; }
        .btn-blue { background: var(--primary); }
        .btn-green { background: var(--success); }
        .btn-dark { background: #374151; padding: 10px 20px; font-size: 0.9rem; }
        .btn-excel { background: #059669; padding: 10px 20px; font-size: 0.9rem; }

        /* TABLE (Screen) */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; font-size: 0.95rem; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        th { text-align: left; padding: 15px; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; font-weight: 700; color: #4b5563; }
        td { padding: 12px 15px; border-bottom: 1px solid #f3f4f6; }
        .col-target { background: #f0fdf4; color: #166534; font-weight: 700; border-left: 1px solid #e5e7eb; }
        .col-gain { color: #059669; font-weight: 700; background: #ecfdf5; text-align: center; }

        /* === PRINT OPTIMIZATION (A4 & 10pt) === */
        @media print {
            @page { size: A4; margin: 1.5cm; }
            body { background: white; font-family: Arial, sans-serif; font-size: 10pt; color: black; padding: 0; margin: 0; }
            .container { box-shadow: none; margin: 0; padding: 0; max-width: 100%; width: 100%; }

            /* Hide UI Elements */
            .step-box, .strategy-panel, .btn, .btn-shuffle, .header-actions, #columnPicker, .signature-controls { display: none !important; }
            
            /* HIDE GAIN COLUMN IN PRINT */
            .col-gain { display: none !important; }

            /* Print Header */
            header { border-bottom: 2px solid black; margin-bottom: 15px; padding-bottom: 10px; justify-content: center; }
            h1 { color: black; font-size: 16pt; text-transform: uppercase; }
            .brand-subtitle { color: #444; }

            /* Print Table */
            #resultSection { display: block !important; }
            h3 { font-size: 12pt; margin-bottom: 10px; border: none !important; padding: 0 !important; }

            table { width: 100%; border-collapse: collapse; border: 1px solid black; font-size: 10pt; }
            th, td { border: 1px solid black; color: black !important; padding: 4px 6px; font-size: 10pt; }
            th { background-color: #f0f0f0 !important; font-weight: bold; }
            .col-target { background: none !important; color: black !important; border-left: 1px solid black; }
            
            tr { page-break-inside: avoid; }
            
            /* MALAY SIGNATURE FOOTER */
            .print-footer { 
                display: flex !important; margin-top: 50px; justify-content: space-between; page-break-inside: avoid; width: 100%;
            }
            .sig-block { width: 45%; }
            .sig-title { font-weight: bold; margin-bottom: 40px; }
            .sig-line { border-top: 1px solid black; margin-top: 5px; margin-bottom: 5px; }
            .sig-text { font-size: 10pt; line-height: 1.5; text-transform: uppercase; }
        }
        .print-footer { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Headcount Like a Pro <span class="brand-subtitle">by Nexus</span></h1>
        <div class="header-actions">
            <button class="btn btn-excel" onclick="downloadExcel()">üì• Download Excel</button>
            <button class="btn btn-dark" onclick="window.print()">üñ®Ô∏è Print / PDF</button>
        </div>
    </header>

    <div class="strategy-panel">
        <div class="strat-header">Target Setting Strategy</div>
        <div class="strat-row">
            <input type="radio" name="strategy" id="stratFixed" value="fixed" checked onchange="updateLive()">
            <label for="stratFixed">Fixed Increase:</label>
            <input type="number" id="fixedVal" value="10" oninput="updateLive()"> 
            <span>marks.</span>
        </div>
        <div class="strat-row">
            <input type="radio" name="strategy" id="stratRandom" value="random" onchange="updateLive()">
            <label for="stratRandom">Random Range:</label>
            <span>Between</span>
            <input type="number" id="randMin" value="5" disabled oninput="updateLive()"> 
            <span>and</span>
            <input type="number" id="randMax" value="12" disabled oninput="updateLive()"> 
            <span>marks.</span>
            <button class="btn-shuffle" id="btnShuffle" onclick="forceReShuffle()">üé≤ Shuffle / Re-Roll</button>
        </div>
    </div>

    <div class="step-box" id="step1">
        <span class="step-title">Step 1: Paste Data (Excel / Sheets)</span>
        <textarea id="pasteArea" placeholder="Paste your entire table here (Must include Headers like 'Name', 'Math', etc.)..."></textarea>
        <br><br>
        <button class="btn btn-blue" onclick="readData()">Analyze Columns</button>
    </div>

    <div class="step-box" id="columnPicker">
        <span class="step-title">Step 2: Select Columns</span>
        <p style="margin:0 0 15px 0; color: #6b7280;">Which subject are we analyzing?</p>
        <div class="picker-grid">
            <div class="picker-group">
                <label>Name Column:</label>
                <select id="nameCol"></select>
            </div>
            <div class="picker-group">
                <label>Subject (TOV) Column:</label>
                <select id="markCol"></select>
            </div>
            <button class="btn btn-green" onclick="generateHeadcount()">Calculate Targets</button>
        </div>
    </div>

    <div id="resultSection" style="display:none;">
        
        <div class="signature-controls">
            <div class="sig-section">
                <h4>Disediakan Oleh (Guru)</h4>
                <div class="input-group">
                    <label>Nama Guru:</label>
                    <input list="teacherList" id="teacherInput" placeholder="Pilih nama guru..." onchange="updateSignature()">
                    <datalist id="teacherList"></datalist>
                </div>
                <div class="input-group">
                    <label>Jawatan:</label>
                    <select id="jawatanInput" onchange="updateSignature()">
                        <option value="" disabled selected>Pilih Jawatan...</option>
                        
                        <optgroup label="GURU MATA PELAJARAN (TERAS)">
                            <option value="GURU MATA PELAJARAN BAHASA MELAYU">GURU MATA PELAJARAN BAHASA MELAYU</option>
                            <option value="GURU MATA PELAJARAN BAHASA INGGERIS">GURU MATA PELAJARAN BAHASA INGGERIS</option>
                            <option value="GURU MATA PELAJARAN MATEMATIK">GURU MATA PELAJARAN MATEMATIK</option>
                            <option value="GURU MATA PELAJARAN SAINS">GURU MATA PELAJARAN SAINS</option>
                            <option value="GURU MATA PELAJARAN PENDIDIKAN ISLAM">GURU MATA PELAJARAN PENDIDIKAN ISLAM</option>
                            <option value="GURU MATA PELAJARAN SEJARAH">GURU MATA PELAJARAN SEJARAH</option>
                        </optgroup>

                        <optgroup label="GURU MATA PELAJARAN (ELEKTIF)">
                            <option value="GURU MATA PELAJARAN RBT">GURU MATA PELAJARAN RBT</option>
                            <option value="GURU MATA PELAJARAN PSV">GURU MATA PELAJARAN PSV</option>
                            <option value="GURU MATA PELAJARAN PENDIDIKAN MUZIK">GURU MATA PELAJARAN PENDIDIKAN MUZIK</option>
                            <option value="GURU MATA PELAJARAN PJPK">GURU MATA PELAJARAN PJPK</option>
                            <option value="GURU MATA PELAJARAN BAHASA ARAB">GURU MATA PELAJARAN BAHASA ARAB</option>
                            <option value="GURU MATA PELAJARAN PENDIDIKAN MORAL">GURU MATA PELAJARAN PENDIDIKAN MORAL</option>
                        </optgroup>
                        
                        <optgroup label="KETUA PANITIA (TERAS)">
                            <option value="KETUA PANITIA BAHASA MELAYU">KETUA PANITIA BAHASA MELAYU</option>
                            <option value="KETUA PANITIA BAHASA INGGERIS">KETUA PANITIA BAHASA INGGERIS</option>
                            <option value="KETUA PANITIA MATEMATIK">KETUA PANITIA MATEMATIK</option>
                            <option value="KETUA PANITIA SAINS">KETUA PANITIA SAINS</option>
                            <option value="KETUA PANITIA PENDIDIKAN ISLAM">KETUA PANITIA PENDIDIKAN ISLAM</option>
                            <option value="KETUA PANITIA SEJARAH">KETUA PANITIA SEJARAH</option>
                        </optgroup>

                        <optgroup label="KETUA PANITIA (ELEKTIF)">
                            <option value="KETUA PANITIA RBT">KETUA PANITIA RBT</option>
                            <option value="KETUA PANITIA PSV">KETUA PANITIA PSV</option>
                            <option value="KETUA PANITIA PENDIDIKAN MUZIK">KETUA PANITIA PENDIDIKAN MUZIK</option>
                            <option value="KETUA PANITIA PJPK">KETUA PANITIA PJPK</option>
                            <option value="KETUA PANITIA BAHASA ARAB">KETUA PANITIA BAHASA ARAB</option>
                            <option value="KETUA PANITIA PENDIDIKAN MORAL">KETUA PANITIA PENDIDIKAN MORAL</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <div class="sig-section">
                <h4>Disahkan Oleh (Pentadbir)</h4>
                <div class="input-group">
                    <label>Nama Pentadbir:</label>
                    <input list="adminList" id="adminInput" placeholder="Pilih nama pentadbir..." onchange="autoFillAdmin()">
                    <datalist id="adminList"></datalist>
                </div>
                <div class="input-group">
                    <label>Jawatan:</label>
                    <input type="text" id="adminJawatanInput" value="GURU BESAR" oninput="updateSignature()">
                </div>
            </div>
        </div>

        <h3 id="subjectTitle" style="margin-bottom:15px; color:#374151; border-left: 5px solid var(--primary); padding-left: 10px;"></h3>
        <table id="dataTable">
            <thead>
                <tr>
                    <th style="width: 5%;">#</th>
                    <th>Student Name</th>
                    <th>TOV</th>
                    <th>OTI1</th>
                    <th>OTI2</th>
                    <th>OTI3</th>
                    <th class="col-target">ETR</th>
                    <th class="col-gain" style="width: 10%;">Gain</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        
        <div class="print-footer">
            <div class="sig-block">
                <div class="sig-title">Disediakan oleh,</div>
                <br><br><br>
                <div class="sig-line"></div>
                <div class="sig-text">Nama: <span id="printName">..............................................................</span></div>
                <div class="sig-text">Jawatan: <span id="printJawatan">...........................................................</span></div>
            </div>

            <div class="sig-block">
                <div class="sig-title">Disahkan oleh,</div>
                <br><br><br>
                <div class="sig-line"></div>
                <div class="sig-text">Nama: <span id="printAdminName">..............................................................</span></div>
                <div class="sig-text">Jawatan: <span id="printAdminJawatan">...........................................................</span></div>
            </div>
        </div>
    </div>
</div>

<script>
    // === 1. DATA CONFIGURATION ===
    const teachers = [
        "AMIRAH BINTI CHE AZUHA", "AZLAN BIN DAUD", "AZLINA BINTI HANAPI", "AMANI BINTI AWANG QAMARULDEEN",
        "ANWAR SHAFIQ BIN JAMALUDIN", "ANIS SYAZWANI BINTI MAT ISA", "BAHJATU SHOLIHAH BINTI RAMAN",
        "FAZILAH BINTI MUDA", "HANIS AYUNI BINTI HADI", "MAKTAR BIN MOHAMED", "MOHD AFIZU BIN ADENAN",
        "MUHAMAD HAKIMI BIN AMER", "MUHAMMAD SAUFI FIRDAUS BIN SABUDIN", "NURAZIZAH BINTI OMAR",
        "NOOR IDAYU BINTI ISMAIL", "NOOR AIN BINTI MOHD YUSOFF", "NOR HUDA DHAMIRAH BINTI ISA",
        "NUR IDAYU BINTI ABDULL ROZAK", "NOR NAZAHIYAH BINTI NASARUDIN", "NOR SHAZIRA BINTI AZIZ",
        "NOR SYAZALIAH BINTI MAT RADZI", "NURIN IZZAH BINTI ROSMAN", "NUR FATIHATULHUSNA BINTI YA'ACOB",
        "NURUL ADILLAH BINTI ZAKARIA", "NURUL IZZATI BINTI MUHAMMAD NAZIR", "NUR ZAKIAH BINTI ZAINUDDIN",
        "RAJIAH BINTI HAJI MUHAMMAD", "RAMLAH BINTI HASSAN", "RAZIAH BINTI WAHAB", "RAUDZAH BINTI HAJI KAMALUDIN",
        "RASHIDAH BINTI ZULKIFLI", "ROSHANIDA BINTI ROHANUDDIN", "SITI ZURAIHA BINTI MAPOL",
        "SUHAIDA BINTI SIDEK", "SUHAIMI BIN ISMAIL", "SUZIMARLIANA BINTI IBRAHIM", "SYAIMA' BINTI ABDUL HALIM@BAKAR",
        "UMMI FARAH BINTI ALIAS", "WAN SITI NOR ADILAH BINTI WAN OTHMAN", "WAN NOOR UMMI BINTI W.RAMLI",
        "ZURAYA BINTI OTHMAN", "ZIRATUL ASYIKIN BINTI MUSA", "ZAILATUL ROZAIDI BIN ZAKARIA"
    ];

    const admins = [
        { name: "ASRI BIN MOHAMED", pos: "GURU BESAR" },
        { name: "TUAN KAMARIAH BINTI TUAN SARIF", pos: "PENOLONG KANAN PENTADBIRAN" },
        { name: "ZAINON BINTI HJ JUFRI", pos: "PENOLONG KANAN HAL EHWAL MURID" },
        { name: "ASYRAF BIN ROSLAN", pos: "PENOLONG KANAN KO-KURIKULUM" }
    ];

    // === 2. INITIALIZATION ===
    const teacherDatalist = document.getElementById('teacherList');
    teachers.forEach(name => {
        let option = document.createElement('option');
        option.value = name;
        teacherDatalist.appendChild(option);
    });

    const adminDatalist = document.getElementById('adminList');
    admins.forEach(admin => {
        let option = document.createElement('option');
        option.value = admin.name;
        adminDatalist.appendChild(option);
    });

    // === 3. SIGNATURE LOGIC ===
    function autoFillAdmin() {
        const selectedName = document.getElementById('adminInput').value;
        const adminObj = admins.find(a => a.name === selectedName);
        if (adminObj) {
            document.getElementById('adminJawatanInput').value = adminObj.pos;
        }
        updateSignature();
    }

    function updateSignature() {
        // Teacher
        const tName = document.getElementById('teacherInput').value;
        const tJaw = document.getElementById('jawatanInput').value;
        document.getElementById('printName').textContent = tName ? tName : "..............................................................";
        document.getElementById('printJawatan').textContent = tJaw ? tJaw : "...........................................................";

        // Admin
        const aName = document.getElementById('adminInput').value;
        const aJaw = document.getElementById('adminJawatanInput').value;
        document.getElementById('printAdminName').textContent = aName ? aName : "..............................................................";
        document.getElementById('printAdminJawatan').textContent = aJaw ? aJaw : "...........................................................";
    }

    // === 4. CORE APP LOGIC ===
    let rawData = [];
    let headers = [];
    let isDataLoaded = false;
    let processedData = [];

    function updateLive() {
        const isFixed = document.getElementById('stratFixed').checked;
        document.getElementById('fixedVal').disabled = !isFixed;
        document.getElementById('randMin').disabled = isFixed;
        document.getElementById('randMax').disabled = isFixed;
        document.getElementById('btnShuffle').style.display = isFixed ? 'none' : 'inline-block';
        if(isDataLoaded) generateHeadcount();
    }

    function forceReShuffle() { if(isDataLoaded) generateHeadcount(); }

    function readData() {
        const text = document.getElementById('pasteArea').value.trim();
        if(!text) return alert("Sila 'Paste' data dahulu.");
        const lines = text.split('\n');
        let firstLine = lines[0].trim();
        let delim = firstLine.includes('\t') ? '\t' : (firstLine.includes(',') ? ',' : ' ');
        headers = firstLine.split(delim).map(h => h.trim());
        if(headers.length < 2) return alert("Ralat: Perlu sekurang-kurangnya 2 lajur (Nama & Markah).");

        const nameSel = document.getElementById('nameCol');
        const markSel = document.getElementById('markCol');
        nameSel.innerHTML = ''; markSel.innerHTML = '';
        headers.forEach((h, i) => {
            let opt = `<option value="${i}">${h}</option>`;
            nameSel.innerHTML += opt;
            markSel.innerHTML += opt;
        });
        headers.forEach((h, i) => {
            let low = h.toLowerCase();
            if(low.includes('name') || low.includes('nama')) nameSel.value = i;
            if(low.includes('mark') || low.includes('tov')) markSel.value = i;
        });
        rawData = lines.slice(1); 
        document.getElementById('columnPicker').style.display = 'block';
    }

    function generateHeadcount() {
        const nameIdx = parseInt(document.getElementById('nameCol').value);
        const markIdx = parseInt(document.getElementById('markCol').value);
        const subject = document.getElementById('markCol').options[markIdx].text;
        
        const isFixed = document.getElementById('stratFixed').checked;
        const fixedVal = parseInt(document.getElementById('fixedVal').value) || 10;
        let minVal = parseInt(document.getElementById('randMin').value) || 1;
        let maxVal = parseInt(document.getElementById('randMax').value) || 10;
        if (minVal > maxVal) { let temp = minVal; minVal = maxVal; maxVal = temp; }

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        processedData = [];
        let count = 0;

        rawData.forEach(line => {
            let delim = line.includes('\t') ? '\t' : (line.includes(',') ? ',' : ' ');
            let parts = (delim === ' ') ? line.trim().split(/\s+/) : line.split(delim);
            if(parts.length <= Math.max(nameIdx, markIdx)) return;

            let name = parts[nameIdx].trim();
            let tov = parseFloat(parts[markIdx].trim());

            if(name && !isNaN(tov)) {
                count++;
                let inc = isFixed ? fixedVal : Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
                let etr = tov + inc;
                if(etr > 100) etr = 100; if(etr < 0) etr = 0; 
                
                let step = (etr - tov) / 4;
                let oti1 = fmt(tov + step);
                let oti2 = fmt(tov + step*2);
                let oti3 = fmt(tov + step*3);
                let etrFmt = fmt(etr);

                processedData.push({ name: name, tov: tov, oti1: oti1, oti2: oti2, oti3: oti3, etr: etrFmt, gain: inc });

                let row = `<tr>
                    <td>${count}</td>
                    <td>${name}</td>
                    <td>${tov}</td>
                    <td>${oti1}</td>
                    <td>${oti2}</td>
                    <td>${oti3}</td>
                    <td class="col-target">${etrFmt}</td>
                    <td class="col-gain">+${inc}</td>
                </tr>`;
                tbody.innerHTML += row;
            }
        });

        document.getElementById('subjectTitle').innerText = "Analisis Headcount: " + subject;
        document.getElementById('resultSection').style.display = 'block';
        isDataLoaded = true;
        updateSignature();
    }

    function downloadExcel() {
        if (!processedData.length) { alert("Sila kira headcount dahulu!"); return; }
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "No,Nama Murid,TOV,OTI 1,OTI 2,OTI 3,ETR,Peningkatan\n";
        processedData.forEach((row, index) => {
            let safeName = row.name.includes(',') ? `"${row.name}"` : row.name;
            csvContent += `${index + 1},${safeName},${row.tov},${row.oti1},${row.oti2},${row.oti3},${row.etr},${row.gain}\n`;
        });
        const markIdx = parseInt(document.getElementById('markCol').value);
        const subject = document.getElementById('markCol').options[markIdx] ? document.getElementById('markCol').options[markIdx].text : "Headcount";
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", `Analisis_Headcount_${subject.replace(/[^a-z0-9]/gi, '_')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function fmt(num) { return Number.isInteger(num) ? num : num.toFixed(2); }
</script>

</body>
</html>
