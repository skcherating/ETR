<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Headcount Pro v27 (Queue)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #2563eb; 
            --secondary: #16a34a; 
            --accent: #f97316;
            --danger: #ef4444;
            --bg: #f1f5f9; 
            --text: #1e293b;
            --border: #cbd5e1;
        }
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 1280px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
        h1 { color: var(--primary); margin: 0; font-size: 1.8rem; font-weight: 800; }
        
        /* BOXES */
        .box { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .box-title { font-weight: 700; color: var(--primary); margin-bottom: 10px; display: block; font-size: 1.1rem; }
        
        /* STRATEGY */
        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .strat-option { background: #eff6ff; padding: 15px; border-radius: 8px; border: 1px solid #bfdbfe; }
        input[type="number"] { padding: 5px; border: 1px solid #94a3b8; border-radius: 4px; width: 60px; text-align: center; font-weight: bold; }

        /* INPUTS */
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #94a3b8; border-radius: 6px; font-family: monospace; }
        
        /* UPLOAD QUEUE STYLES */
        .upload-wrapper { border: 2px dashed #94a3b8; background: #f8fafc; padding: 15px; border-radius: 8px; }
        .btn-add { background: var(--secondary); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; width: 100%; justify-content: center; }
        .btn-add:hover { background: #15803d; }
        
        .file-queue { margin-top: 15px; display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }
        .file-item { display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid #e2e8f0; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; }
        .file-info { display: flex; align-items: center; gap: 8px; }
        .file-icon { font-size: 1.2rem; }
        .btn-remove { background: none; border: none; color: var(--danger); font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        .btn-remove:hover { color: #b91c1c; }
        .empty-msg { text-align: center; color: #64748b; font-style: italic; font-size: 0.9rem; margin-top: 10px; }

        /* COLUMN PICKER */
        .picker-container { background: #f0fdf4; border: 1px solid #86efac; padding: 20px; border-radius: 8px; display: none; margin-bottom: 20px; }
        select { width: 100%; padding: 10px; border: 1px solid #94a3b8; border-radius: 6px; background: #fff; }

        /* PBD PANEL */
        .pbd-panel { 
            background: #fff7ed; border: 2px solid #fdba74; padding: 20px; border-radius: 10px; margin-bottom: 20px; 
            display: flex; flex-direction: column; gap: 10px;
        }
        .pbd-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .pbd-btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .pbd-btn:hover { background: #ea580c; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        th { background: #e2e8f0; padding: 10px; border: 1px solid #94a3b8; font-weight: 700; text-align: center; color: #334155; }
        td { border: 1px solid #cbd5e1; padding: 5px; text-align: center; }
        td:nth-child(2) { text-align: left; padding-left: 10px; } 
        
        .col-mark { background: #eff6ff; }
        .col-pbd { background: #f0fdf4; }
        .col-target { font-weight: bold; color: var(--primary); background: #dbeafe; }
        .tp-select { padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; width: 100%; text-align: center; cursor: pointer; font-weight: 600; }

        /* Buttons */
        .btn-main { background: var(--primary); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-sm { padding: 8px 15px; font-size: 0.9rem; border-radius: 6px; border: none; cursor: pointer; color: white; font-weight: 600; }

        /* PRINT */
        @media print {
            @page { size: A4 landscape; margin: 1cm; }
            .container { box-shadow: none; padding: 0; max-width: 100%; }
            .box, .btn-main, .header-actions, .picker-container, .pbd-panel { display: none !important; }
            header { border-bottom: 2px solid #000; }
            table { border: 1px solid #000; width: 100%; font-size: 9pt; }
            th, td { border: 1px solid #000; padding: 4px; color: #000 !important; }
            .col-mark, .col-pbd, .col-target { background: none !important; }
            .tp-select { border: none; background: transparent; appearance: none; padding: 0; color: #000; font-weight: bold; }
            #resultSection { display: block !important; }
            .print-footer { display: flex !important; margin-top: 40px; justify-content: space-between; page-break-inside: avoid; }
            .sig-box { width: 40%; }
            .sig-line { border-top: 1px solid #000; margin-top: 50px; margin-bottom: 5px; }
        }
        .print-footer { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Nexus Headcount Pro <span class="brand-subtitle">v27 Queue</span></h1>
        <div class="header-actions">
            <button class="btn-sm" style="background:#16a34a;" onclick="downloadExcel()">üì• Excel</button>
            <button class="btn-sm" style="background:#334155;" onclick="window.print()">üñ®Ô∏è Cetak</button>
        </div>
    </header>

    <div class="box">
        <span class="box-title">1. Strategi Markah (TOV ‚û°Ô∏è ETR)</span>
        <div class="strat-grid">
            <div class="strat-option">
                <input type="radio" name="strat" id="stratFixed" checked>
                <label for="stratFixed"><b>Statik:</b></label> Tambah <input type="number" id="valFixed" value="10"> markah.
            </div>
            <div class="strat-option">
                <input type="radio" name="strat" id="stratRandom">
                <label for="stratRandom"><b>Rawak:</b></label> Antara <input type="number" id="valMin" value="5"> - <input type="number" id="valMax" value="12">.
            </div>
        </div>
    </div>

    <div class="box">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
            <div>
                <span class="box-title">2A. Master List Nama</span>
                <textarea id="masterList" placeholder="Paste nama murid ikut susunan kelas terkini (2026)..."></textarea>
            </div>
            
            <div>
                <span class="box-title">2B. Upload Excel (Sistem Tambah +)</span>
                <div class="upload-wrapper">
                    <button class="btn-add" onclick="document.getElementById('fileInput').click()">
                        <span>‚ûï</span> Tambah Fail Excel
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" hidden onchange="handleFileAdd(this)">
                    
                    <div id="fileQueueDisplay" class="file-queue">
                        <div class="empty-msg">Tiada fail ditambah. Sila tekan butang (+) di atas.</div>
                    </div>
                </div>
            </div>
        </div>
        <button class="btn-main" onclick="analyzeData()">üîç Gabung & Padankan Data</button>
    </div>

    <div class="picker-container" id="columnPicker">
        <span class="box-title">3. Padankan Kolum (Dikesan dari semua fail)</span>
        <div style="display:flex; gap:20px;">
            <div style="flex:1;">
                <label style="font-weight:600; color:#166534; display:block; margin-bottom:5px;">Pilih Kolum NAMA:</label>
                <select id="colName"></select>
            </div>
            <div style="flex:1;">
                <label style="font-weight:600; color:#1e40af; display:block; margin-bottom:5px;">Pilih Kolum MARKAH (TOV):</label>
                <select id="colMark"></select>
            </div>
        </div>
        <button class="btn-main" style="background:var(--secondary); margin-top:20px;" onclick="generateHeadcount()">Jana Analisis</button>
    </div>

    <div id="resultSection" style="display:none;">
        
        <div class="pbd-panel">
            <span style="font-weight:800; color:#9a3412;">‚ö° Generator PBD Pukal (Isi Cepat)</span>
            <div class="pbd-row">
                <select id="pbdTarget" style="padding:8px; border-radius:6px; border:1px solid #fdba74;">
                    <option value="tov">1. TOV PBD 2025</option>
                    <option value="up">2. UP PBD 2026</option>
                    <option value="uasa">3. UASA PBD 2026</option>
                </select>

                <select id="pbdMode" style="padding:8px; border-radius:6px; border:1px solid #fdba74;" onchange="togglePbdInputs()">
                    <option value="static">Statik (Semua Sama)</option>
                    <option value="random">Rawak (Julat)</option>
                </select>

                <div id="pbdStaticInputs" style="display:flex; align-items:center; gap:5px;">
                    <b>TP:</b> <input type="number" id="valPbdStatic" value="4" min="1" max="6">
                </div>
                <div id="pbdRandomInputs" style="display:none; align-items:center; gap:5px;">
                    <b>Min:</b> <input type="number" id="valPbdMin" value="3" min="1" max="6">
                    <b>Max:</b> <input type="number" id="valPbdMax" value="5" min="1" max="6">
                </div>

                <button class="pbd-btn" onclick="applyBulkPBD()">Jana</button>
            </div>
        </div>

        <h3 id="tableHeader" style="margin-bottom:15px; color:#334155;">Analisis Headcount & PBD</h3>
        
        <table id="dataTable">
            <thead>
                <tr>
                    <th rowspan="2" style="width:5%;">No</th>
                    <th rowspan="2">Nama Murid</th>
                    <th colspan="3" class="col-mark">MARKAH (0-100)</th>
                    <th colspan="3" class="col-pbd">PBD (TAHAP PENGUASAAN)</th>
                </tr>
                <tr>
                    <th class="col-mark">TOV 2025</th>
                    <th class="col-mark col-target">ETR 2026</th>
                    <th class="col-mark">Gain</th>
                    <th class="col-pbd">TOV PBD 2025</th>
                    <th class="col-pbd">UP PBD 2026</th>
                    <th class="col-pbd">UASA PBD 2026</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="print-footer">
            <div class="sig-box">
                <div>Disediakan oleh,</div>
                <div class="sig-line"></div>
                <div>Nama: .....................................................</div>
                <div>Jawatan: GURU MATA PELAJARAN</div>
            </div>
            <div class="sig-box">
                <div>Disahkan oleh,</div>
                <div class="sig-line"></div>
                <div>Nama: .....................................................</div>
                <div>Jawatan: GURU BESAR</div>
            </div>
        </div>
    </div>
</div>

<script>
    // === GLOBAL STORE ===
    let masterList = [];
    let allFilesData = []; // Store multiple files here: [{id, name, data}]
    let detectedHeaders = [];

    // === UI UTILS ===
    function togglePbdInputs() {
        const mode = document.getElementById('pbdMode').value;
        document.getElementById('pbdStaticInputs').style.display = (mode === 'static') ? 'flex' : 'none';
        document.getElementById('pbdRandomInputs').style.display = (mode === 'random') ? 'flex' : 'none';
    }

    // === CUMULATIVE FILE HANDLING ===
    function handleFileAdd(input) {
        if(input.files.length === 0) return;
        
        const file = input.files[0]; // Take the first one selected
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            
            // Add to Global Array
            const fileObj = {
                id: Date.now(), // Unique ID for removal
                name: file.name,
                data: jsonData
            };
            allFilesData.push(fileObj);
            
            // Refresh UI
            renderFileList();
        };
        
        reader.readAsArrayBuffer(file);
        
        // Clear input to allow adding same file again if needed
        input.value = ''; 
    }

    function renderFileList() {
        const container = document.getElementById('fileQueueDisplay');
        container.innerHTML = '';

        if(allFilesData.length === 0) {
            container.innerHTML = '<div class="empty-msg">Tiada fail ditambah. Sila tekan butang (+) di atas.</div>';
            return;
        }

        allFilesData.forEach(file => {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
                <div class="file-info">
                    <span class="file-icon">üìÑ</span>
                    <div>
                        <strong>${file.name}</strong><br>
                        <span style="font-size:0.8rem; color:#64748b;">${file.data.length} baris</span>
                    </div>
                </div>
                <button class="btn-remove" onclick="removeFile(${file.id})">&times;</button>
            `;
            container.appendChild(div);
        });
    }

    function removeFile(id) {
        allFilesData = allFilesData.filter(f => f.id !== id);
        renderFileList();
    }

    // === ANALYZE DATA (MERGE & HEADER SCAN) ===
    function findHeaderRow(data) {
        // Find row containing "NAMA"
        for(let i=0; i < Math.min(data.length, 20); i++) {
            const rowStr = data[i].join(' ').toUpperCase();
            if(rowStr.includes('NAMA') || rowStr.includes('NAME')) return i;
        }
        return 0; 
    }

    function analyzeData() {
        const mText = document.getElementById('masterList').value.trim();
        if(!mText) return alert("Sila masukkan Senarai Nama Master.");
        masterList = mText.split('\n').map(l => l.trim().replace(/^\d+[\.\)]\s*/, '')).filter(l => l);

        if(allFilesData.length === 0) return alert("Sila tambah sekurang-kurangnya satu fail Excel.");

        // Use the first file to populate picker (Assumption: All files have similar structure)
        // If they differ, the picker will rely on the first file's structure.
        const sampleData = allFilesData[0].data;
        const headerIdx = findHeaderRow(sampleData);
        detectedHeaders = sampleData[headerIdx];

        // Populate Pickers
        const selName = document.getElementById('colName');
        const selMark = document.getElementById('colMark');
        selName.innerHTML = ''; selMark.innerHTML = '';

        detectedHeaders.forEach((h, i) => {
            const text = h ? h.toString() : `[Kolum ${i+1}]`;
            const opt = `<option value="${i}">${text}</option>`;
            selName.innerHTML += opt;
            selMark.innerHTML += opt;
        });

        // Smart Select Guess
        detectedHeaders.forEach((h, i) => {
            if(!h) return;
            const t = h.toString().toLowerCase();
            if(t.includes('nama') || t.includes('name')) selName.value = i;
            if(t.includes('mark') || t.includes('tov') || t.includes('ahk')) selMark.value = i;
        });

        document.getElementById('columnPicker').style.display = 'block';
    }

    // === GENERATE HEADCOUNT ===
    function generateHeadcount() {
        const nameIdx = parseInt(document.getElementById('colName').value);
        const markIdx = parseInt(document.getElementById('colMark').value);

        // Map Data from ALL FILES
        let dataMap = {};

        allFilesData.forEach(file => {
            const data = file.data;
            const hIdx = findHeaderRow(data);
            
            // Loop data rows (skip header)
            for(let i = hIdx + 1; i < data.length; i++) {
                const row = data[i];
                if(row && row[nameIdx]) {
                    const name = row[nameIdx].toString().trim().toUpperCase();
                    const rawMark = row[markIdx];
                    
                    // Logic: Find mark, allow "TH"
                    let finalMark = null;
                    if (rawMark !== undefined && rawMark !== null && rawMark !== "") {
                        let parsed = parseFloat(rawMark);
                        if (!isNaN(parsed)) {
                            finalMark = parsed;
                        } else {
                            let str = rawMark.toString().trim().toUpperCase();
                            if (str === "TH" || str === "G" || str === "TIDAK HADIR") finalMark = "TH";
                        }
                    }
                    if (finalMark !== null) dataMap[name] = finalMark;
                }
            }
        });

        // Strategy
        const isFixed = document.getElementById('stratFixed').checked;
        const fixVal = parseInt(document.getElementById('valFixed').value);
        const minVal = parseInt(document.getElementById('valMin').value);
        const maxVal = parseInt(document.getElementById('valMax').value);

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        let count = 0;
        masterList.forEach(name => {
            count++;
            const cleanName = name.toUpperCase();
            const tov = dataMap[cleanName]; // can be undefined, number, or "TH"
            
            let displayTov = "-";
            let displayEtr = "-";
            let displayGain = "-";

            if (typeof tov === 'number') {
                displayTov = tov;
                const inc = isFixed ? fixVal : Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
                let etr = tov + inc;
                if(etr > 100) etr = 100;
                displayEtr = etr;
                displayGain = "+" + inc;
            } else if (tov === "TH") {
                displayTov = "TH";
                displayEtr = "TH";
            }

            const row = `
                <tr>
                    <td>${count}</td>
                    <td>${name}</td>
                    <td style="background:#f8fafc;">${displayTov}</td>
                    <td class="col-target">${displayEtr}</td>
                    <td style="color:green; font-size:0.8rem;">${displayGain}</td>
                    <td>${createTpSelect('tov', 3)}</td>
                    <td>${createTpSelect('up', 3)}</td>
                    <td>${createTpSelect('uasa', 3)}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        document.getElementById('resultSection').style.display = 'block';
        document.getElementById('tableHeader').scrollIntoView({behavior: 'smooth'});
    }

    function createTpSelect(type, val) {
        let html = `<select class="tp-select" data-type="${type}">`;
        for(let i=1; i<=6; i++) {
            html += `<option value="${i}" ${i==val?'selected':''}>TP ${i}</option>`;
        }
        html += `</select>`;
        return html;
    }

    // === PBD GENERATOR ===
    function applyBulkPBD() {
        const target = document.getElementById('pbdTarget').value; 
        const mode = document.getElementById('pbdMode').value;
        const selects = document.querySelectorAll(`select[data-type="${target}"]`);
        
        selects.forEach(sel => {
            let newVal = 1;
            if (mode === 'static') {
                newVal = parseInt(document.getElementById('valPbdStatic').value);
            } else {
                const min = parseInt(document.getElementById('valPbdMin').value);
                const max = parseInt(document.getElementById('valPbdMax').value);
                newVal = Math.floor(Math.random() * (max - min + 1)) + min;
            }
            sel.value = newVal;
        });
        alert("PBD Dikemaskini!");
    }

    // === EXPORT ===
    function downloadExcel() {
        let csv = "No,Nama Murid,TOV Markah,ETR Markah,Gain,TOV PBD 2025,UP PBD 2026,UASA PBD 2026\n";
        const rows = document.querySelectorAll('#tableBody tr');
        
        if(rows.length === 0) return alert("Tiada data.");

        rows.forEach((tr, i) => {
            const tds = tr.children;
            const no = i + 1;
            const name = tds[1].innerText;
            const tovM = tds[2].innerText;
            const etrM = tds[3].innerText;
            const gain = tds[4].innerText;
            
            const tovP = tds[5].querySelector('select').value;
            const upP = tds[6].querySelector('select').value;
            const uasaP = tds[7].querySelector('select').value;

            csv += `${no},"${name}",${tovM},${etrM},${gain},TP ${tovP},TP ${upP},TP ${uasaP}\n`;
        });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = "Analisis_Headcount_PBD_v27.csv";
        link.click();
    }
</script>

</body>
</html>
